name: Daily AI News Collection

on:
  schedule:
    # Run at 21:30 UTC (6:30 JST next day)
    - cron: '30 21 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run news collector
        env:
          X_USERNAME: ${{ secrets.X_USERNAME }}
          X_PASSWORD: ${{ secrets.X_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
          CT0: ${{ secrets.CT0 }}
        run: python main.py

      - name: Generate cover image with date
        run: |
          python -c "
          from src.cover_generator import add_date_to_cover
          from datetime import datetime
          from zoneinfo import ZoneInfo
          import os
          
          # Use JST timezone to match main.py
          jst = ZoneInfo('Asia/Tokyo')
          today = datetime.now(jst)
          date_str = today.strftime('%Y-%m-%d')
          output_dir = f'output/{date_str}'
          os.makedirs(output_dir, exist_ok=True)
          
          add_date_to_cover(
              'assets/Untitled design.png',
              f'{output_dir}/cover.png',
              today
          )
          "

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          if [ -n "$(git status --porcelain output/)" ]; then
            git add output/
            # Use JST timezone for commit message
            git commit -m "ğŸ“° Daily AI news update - $(TZ=Asia/Tokyo date +%Y-%m-%d)"
            git push
            echo "âœ… Changes committed and pushed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-news-${{ github.run_number }}
          path: output/
          retention-days: 30

      - name: Get article and cover paths
        id: article
        run: |
          # Get today's date in JST timezone to match main.py's output directory
          TODAY=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          ARTICLE_PATH="output/${TODAY}/article.md"
          COVER_PATH="output/${TODAY}/cover.png"
          
          echo "Looking for: $ARTICLE_PATH"
          
          if [ -f "$ARTICLE_PATH" ]; then
            echo "article_found=true" >> $GITHUB_OUTPUT
            echo "article_path=$ARTICLE_PATH" >> $GITHUB_OUTPUT
            echo "cover_path=$COVER_PATH" >> $GITHUB_OUTPUT
            echo "âœ… Found today's article: $ARTICLE_PATH"
          else
            # Fallback: find the latest by directory name (sorted alphabetically = by date)
            LATEST_DIR=$(ls -d output/*/ 2>/dev/null | sort -r | head -1)
            if [ -n "$LATEST_DIR" ] && [ -f "${LATEST_DIR}article.md" ]; then
              ARTICLE_PATH="${LATEST_DIR}article.md"
              COVER_PATH="${LATEST_DIR}cover.png"
              echo "article_found=true" >> $GITHUB_OUTPUT
              echo "article_path=$ARTICLE_PATH" >> $GITHUB_OUTPUT
              echo "cover_path=$COVER_PATH" >> $GITHUB_OUTPUT
              echo "âš ï¸ Today's article not found, using latest: $ARTICLE_PATH"
            else
              echo "article_found=false" >> $GITHUB_OUTPUT
              echo "âŒ No article found"
            fi
          fi

      - name: Install Playwright
        if: steps.article.outputs.article_found == 'true'
        run: |
          pip install playwright
          playwright install chromium

      - name: Publish to note.com
        id: note
        if: steps.article.outputs.article_found == 'true'
        env:
          NOTE_COOKIES: ${{ secrets.NOTE_COOKIES }}
        run: |
          # Save cookies to file
          echo "$NOTE_COOKIES" > note_cookies.json
          
          # Run publisher and capture output
          OUTPUT=$(python src/note_publisher.py publish "${{ steps.article.outputs.article_path }}" "${{ steps.article.outputs.cover_path }}" 2>&1)
          echo "$OUTPUT"
          
          # Extract draft URL from output
          DRAFT_URL=$(echo "$OUTPUT" | grep -o 'https://editor.note.com/notes/[^/]*/edit/' | head -1)
          
          if [ -n "$DRAFT_URL" ]; then
            echo "draft_url=$DRAFT_URL" >> $GITHUB_OUTPUT
            echo "âœ… Draft URL: $DRAFT_URL"
          else
            echo "draft_url=" >> $GITHUB_OUTPUT
            echo "âš ï¸ Could not extract draft URL"
          fi
          
          # Clean up cookies
          rm -f note_cookies.json

      - name: Send email notification
        if: steps.article.outputs.article_found == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ ã‚«ã‚¨ãƒ‡ã®AIãƒ‹ãƒ¥ãƒ¼ã‚¹ã€${{ github.run_id }}ã€‘"
          to: ${{ secrets.EMAIL_TO }}
          from: Kaede AI News <${{ secrets.EMAIL_USERNAME }}>
          body: |
            æœ¬æ—¥ã®AIãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠå±Šã‘ã—ã¾ã™ï¼
            
            ğŸ“ note.com è‰ç¨¿ã‚’ç·¨é›†ã™ã‚‹:
            ${{ steps.note.outputs.draft_url || 'https://note.com/notes' }}
            
            ğŸ“ GitHub ã§å…¨æ–‡ã‚’è¦‹ã‚‹: 
            https://github.com/${{ github.repository }}/blob/main/${{ steps.article.outputs.article_path }}
            
            ---
            ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚
          attachments: ${{ steps.article.outputs.article_path }},${{ steps.article.outputs.cover_path }}
